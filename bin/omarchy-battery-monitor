#!/bin/bash

# Designed to be run by systemd timer every 30 seconds and alerts if battery is low

BATTERY_THRESHOLD=10
NOTIFICATION_FLAG="/run/user/$UID/omarchy_battery_notified"
BATTERY_LEVEL=$(omarchy-battery-remaining)
BATTERY_STATE=$(upower -i $(upower -e | grep 'BAT') | grep -E "state" | awk '{print $2}')

send_notification() {
  notify-send -u critical "Û±êã Time to recharge!" "Battery is down to ${1}%" -i battery-caution -t 30000
}

# Exit early if battery level is empty or not a valid number
# credit: Issue #2886 by data-davey
if [[ -z "$BATTERY_LEVEL" ]] || ! [[ "$BATTERY_LEVEL" =~ ^[0-9]+$ ]]; then
  exit 0
fi

if [[ $BATTERY_STATE == "discharging" && $BATTERY_LEVEL -le $BATTERY_THRESHOLD ]]; then
  if [[ ! -f $NOTIFICATION_FLAG ]]; then
    send_notification $BATTERY_LEVEL
    touch $NOTIFICATION_FLAG
  fi
else
  rm -f $NOTIFICATION_FLAG
fi
